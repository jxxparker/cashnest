<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashnest</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="img/download.jpg" />
  </head>
  <body>
    <nav id="main-nav" style="display: none">
      <div class="nav-features">
        <button onclick="showSection('networth')">Net Worth</button>
        <button onclick="showSection('expenses')">Expenses</button>
      </div>
      <div class="nav-user">
        <button id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
          üåô
        </button>
        <span id="nav-username"></span>
        <button onclick="logout()">Logout</button>
      </div>
    </nav>
    <main>
      <section id="auth-section">
        <h2>Login / Register</h2>
        <form id="login-form">
          <input
            type="text"
            id="login-username"
            placeholder="Username"
            required
          />
          <input
            type="password"
            id="login-password"
            placeholder="Password"
            required
          />
          <button type="submit">Login</button>
        </form>
        <form id="register-form">
          <input
            type="text"
            id="register-username"
            placeholder="Username"
            required
          />
          <input
            type="password"
            id="register-password"
            placeholder="Password"
            required
          />
          <button type="submit">Register</button>
        </form>
        <div id="auth-message"></div>
      </section>
      <section id="networth-section" style="display: none">
        <h2>Net Worth Tracker</h2>
        <div id="networth-root"></div>
        <form id="add-asset-form">
          <input
            type="text"
            id="asset-name"
            placeholder="Asset Name"
            required
          />
          <input type="number" id="asset-value" placeholder="Value" required />
          <button type="submit">Add Asset</button>
        </form>
        <form id="add-debt-form">
          <input type="text" id="debt-name" placeholder="Debt Name" required />
          <input type="number" id="debt-value" placeholder="Value" required />
          <button type="submit">Add Debt</button>
        </form>
        <form id="add-stock-form">
          <input
            type="text"
            id="stock-symbol"
            placeholder="Stock Symbol"
            required
          />
          <input
            type="number"
            id="stock-shares"
            placeholder="Shares"
            required
          />
          <button type="submit">Add Stock</button>
        </form>
      </section>
      <section id="expenses-section" style="display: none">
        <h2>Expense Tracker</h2>
        <form id="add-expense-form">
          <input type="date" id="expense-date" required />
          <input
            type="number"
            id="expense-amount"
            placeholder="Amount"
            required
          />
          <input
            type="text"
            id="expense-details"
            placeholder="Details"
            required
          />
          <select
            id="expense-category"
            required
            style="
              padding: 0.5em 1em;
              font-size: 1rem;
              border-radius: 6px;
              border: 1px solid #ddd;
            "
          >
            <option value="">Select Category</option>
            <option value="Grocery">Grocery</option>
            <option value="Bills">Bills</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Financed Items">Financed Items</option>
            <option value="Investments">Investments</option>
            <option value="Food">Food</option>
            <option value="Transportation">Transportation</option>
            <option value="Hospital/Emergency">Hospital/Emergency</option>
          </select>
          <button type="submit">Add Expense</button>
        </form>
        <div id="expenses-root"></div>
      </section>
    </main>
    <script src="networth/networth.js"></script>
    <script src="expenses/expenses.js"></script>
    <script>
      function showSection(section) {
        document.getElementById("networth-section").style.display = "none";
        document.getElementById("expenses-section").style.display = "none";
        document.getElementById("auth-section").style.display = "none";
        localStorage.setItem("lastSection", section);

        if (section === "networth") {
          document.getElementById("networth-section").style.display = "block";
        } else if (section === "expenses") {
          document.getElementById("expenses-section").style.display = "block";
        } else {
          document.getElementById("auth-section").style.display = "block";
        }

        // Ensure theme persists when switching sections
        setTimeout(() => {
          initializeTheme();
        }, 50);
      }

      window.onload = function () {
        // Initialize theme first
        initializeTheme();

        const token = localStorage.getItem("token");
        if (token) {
          // Try to get username from token or localStorage
          let username = localStorage.getItem("username");
          if (!username) {
            // If no stored username, try to decode from token (basic approach)
            try {
              const payload = JSON.parse(atob(token.split(".")[1]));
              username = payload.username || "User";
              localStorage.setItem("username", username);
            } catch (e) {
              username = "User";
            }
          }

          // Set username in navigation
          document.getElementById(
            "nav-username"
          ).textContent = `Hello, ${username}`;

          document.getElementById("main-nav").style.display = "block";
          const lastSection = localStorage.getItem("lastSection") || "networth";
          showSection(lastSection);
        } else {
          document.getElementById("main-nav").style.display = "none";
          showSection("auth");
        }
      };

      document.getElementById("login-form").onsubmit = async function (e) {
        e.preventDefault();
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;
        try {
          const res = await fetch("http://3.229.166.20:4000/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok && data.token) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("username", username);

            // Set username in navigation
            document.getElementById(
              "nav-username"
            ).textContent = `Hello, ${username}`;

            // Show navigation and switch to networth
            document.getElementById("main-nav").style.display = "block";
            showSection("networth");

            // Reinitialize theme after login
            initializeTheme();

            document.getElementById("auth-message").textContent = "";
          } else {
            document.getElementById("auth-message").textContent =
              data.error || data.message || "Login failed";
          }
        } catch (err) {
          document.getElementById("auth-message").textContent = "Network error";
        }
      };

      document.getElementById("register-form").onsubmit = async function (e) {
        e.preventDefault();
        const username = document.getElementById("register-username").value;
        const password = document.getElementById("register-password").value;
        try {
          const res = await fetch(
            "http://3.229.166.20:4000/api/auth/register",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            }
          );
          const data = await res.json();
          if (res.ok && data.message) {
            document.getElementById("auth-message").textContent =
              "Registration successful! Please log in.";
          } else {
            document.getElementById("auth-message").textContent =
              data.error || data.message || "Registration failed";
          }
        } catch (err) {
          document.getElementById("auth-message").textContent = "Network error";
        }
      };

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        document.getElementById("main-nav").style.display = "none";
        document.getElementById("nav-username").textContent = "";
        showSection("auth");
        document.getElementById("auth-message").textContent = "";
      }

      // Theme toggle functionality
      function toggleTheme() {
        console.log("Theme toggle clicked!"); // Debug log
        const body = document.body;
        const themeToggle = document.getElementById("theme-toggle");

        if (body.classList.contains("dark-theme")) {
          body.classList.remove("dark-theme");
          themeToggle.textContent = "üåô";
          localStorage.setItem("theme", "light");
          console.log("Switched to light theme");
        } else {
          body.classList.add("dark-theme");
          themeToggle.textContent = "‚òÄÔ∏è";
          localStorage.setItem("theme", "dark");
          console.log("Switched to dark theme");
        }
      }

      // Initialize theme on page load
      function initializeTheme() {
        const savedTheme = localStorage.getItem("theme");
        const themeToggle = document.getElementById("theme-toggle");
        console.log("Initializing theme:", savedTheme); // Debug log

        if (savedTheme === "dark") {
          document.body.classList.add("dark-theme");
          if (themeToggle) themeToggle.textContent = "‚òÄÔ∏è";
        } else {
          document.body.classList.remove("dark-theme");
          if (themeToggle) themeToggle.textContent = "üåô";
        }
      }
    </script>
  </body>
</html>
